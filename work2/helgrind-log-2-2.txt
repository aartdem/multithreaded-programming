==18980== Helgrind, a thread error detector
==18980== Copyright (C) 2007-2017, and GNU GPL'd, by OpenWorks LLP et al.
==18980== Using Valgrind-3.18.1 and LibVEX; rerun with -h for copyright info
==18980== Command: ./main
==18980== Parent PID: 11488
==18980== 
==18980== ---Thread-Announcement------------------------------------------
==18980== 
==18980== Thread #1 is the program's root thread
==18980== 
==18980== ----------------------------------------------------------------
==18980== 
==18980== Thread #1: pthread_cond_{signal,broadcast}: dubious: associated lock is not held by any thread
==18980==    at 0x48513D6: ??? (in /usr/libexec/valgrind/vgpreload_helgrind-amd64-linux.so)
==18980==    by 0x10BB9D: std::future<std::result_of<main::{lambda()#1} ()>::type> ThreadPool::enqueue<main::{lambda()#1}>(main::{lambda()#1}&&) (ThreadPool.h:82)
==18980==    by 0x10B8B5: main (example.cpp:15)
==18980== 
==18980== ---Thread-Announcement------------------------------------------
==18980== 
==18980== Thread #3 was created
==18980==    at 0x4BE89F3: clone (clone.S:76)
==18980==    by 0x4BE98EE: __clone_internal (clone-internal.c:83)
==18980==    by 0x4B576D8: create_thread (pthread_create.c:295)
==18980==    by 0x4B581FF: pthread_create@@GLIBC_2.34 (pthread_create.c:828)
==18980==    by 0x4853767: ??? (in /usr/libexec/valgrind/vgpreload_helgrind-amd64-linux.so)
==18980==    by 0x4953328: std::thread::_M_start_thread(std::unique_ptr<std::thread::_State, std::default_delete<std::thread::_State> >, void (*)()) (in /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.30)
==18980==    by 0x1143AF: std::thread::thread<ThreadPool::ThreadPool(unsigned long)::{lambda()#1}, , void>(ThreadPool::ThreadPool(unsigned long)::{lambda()#1}&&) (std_thread.h:143)
==18980==    by 0x1136DE: void __gnu_cxx::new_allocator<std::thread>::construct<std::thread, ThreadPool::ThreadPool(unsigned long)::{lambda()#1}>(std::thread*, ThreadPool::ThreadPool(unsigned long)::{lambda()#1}&&) (new_allocator.h:162)
==18980==    by 0x111F2B: void std::allocator_traits<std::allocator<std::thread> >::construct<std::thread, ThreadPool::ThreadPool(unsigned long)::{lambda()#1}>(std::allocator<std::thread>&, std::thread*, ThreadPool::ThreadPool(unsigned long)::{lambda()#1}&&) (alloc_traits.h:516)
==18980==    by 0x112001: void std::vector<std::thread, std::allocator<std::thread> >::_M_realloc_insert<ThreadPool::ThreadPool(unsigned long)::{lambda()#1}>(__gnu_cxx::__normal_iterator<std::thread*, std::vector<std::thread, std::allocator<std::thread> > >, ThreadPool::ThreadPool(unsigned long)::{lambda()#1}&&) (vector.tcc:449)
==18980==    by 0x1108A1: std::thread& std::vector<std::thread, std::allocator<std::thread> >::emplace_back<ThreadPool::ThreadPool(unsigned long)::{lambda()#1}>(ThreadPool::ThreadPool(unsigned long)::{lambda()#1}&&) (vector.tcc:121)
==18980==    by 0x10F84D: ThreadPool::ThreadPool(unsigned long) (ThreadPool.h:38)
==18980== 
==18980== ----------------------------------------------------------------
==18980== 
==18980== Possible data race during read of size 8 at 0x4DEA6D8 by thread #1
==18980== Locks held: none
==18980==    at 0x112B14: std::__uniq_ptr_impl<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>::_M_ptr() const (unique_ptr.h:173)
==18980==    by 0x111251: std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>::get() const (unique_ptr.h:422)
==18980==    by 0x10FCEC: std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>::operator*() const (unique_ptr.h:408)
==18980==    by 0x10EF10: std::__future_base::_State_baseV2::wait() (future:337)
==18980==    by 0x112891: std::__basic_future<int>::_M_get_result() const (future:719)
==18980==    by 0x110FB2: std::future<int>::get() (future:805)
==18980==    by 0x10B94E: main (example.cpp:26)
==18980== 
==18980== This conflicts with a previous write of size 8 by thread #3
==18980== Locks held: none
==18980==    at 0x112D10: std::enable_if<std::__and_<std::__not_<std::__is_tuple_like<std::__future_base::_Result_base*> >, std::is_move_constructible<std::__future_base::_Result_base*>, std::is_move_assignable<std::__future_base::_Result_base*> >::value, void>::type std::swap<std::__future_base::_Result_base*>(std::__future_base::_Result_base*&, std::__future_base::_Result_base*&) (move.h:205)
==18980==    by 0x1116EA: std::__uniq_ptr_impl<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>::swap(std::__uniq_ptr_impl<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>&) (unique_ptr.h:196)
==18980==    by 0x110180: std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>::swap(std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>&) (unique_ptr.h:464)
==18980==    by 0x10F41D: std::__future_base::_State_baseV2::_M_do_set(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*) (future:576)
==18980==    by 0x112BB4: void std::__invoke_impl<void, void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::__invoke_memfun_deref, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) (invoke.h:74)
==18980==    by 0x111306: std::__invoke_result<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>::type std::__invoke<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) (invoke.h:96)
==18980==    by 0x10FD81: std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#1}::operator()() const (mutex:776)
==18980==    by 0x111336: std::once_flag::_Prepare_execution::_Prepare_execution<std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#1}>(void (std::__future_base::_State_baseV2::*&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*))::{lambda()#1}::operator()() const (mutex:712)
==18980==  Address 0x4dea6d8 is 24 bytes inside a block of size 64 alloc'd
==18980==    at 0x484B093: operator new(unsigned long) (in /usr/libexec/valgrind/vgpreload_helgrind-amd64-linux.so)
==18980==    by 0x10D0F5: __gnu_cxx::new_allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> >::allocate(unsigned long, void const*) (new_allocator.h:127)
==18980==    by 0x10CF7C: std::allocator_traits<std::allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> > >::allocate(std::allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> >&, unsigned long) (alloc_traits.h:464)
==18980==    by 0x10CD69: std::__allocated_ptr<std::allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> > > std::__allocate_guarded<std::allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> > >(std::allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> >&) (allocated_ptr.h:98)
==18980==    by 0x10CBBB: std::__shared_count<(__gnu_cxx::_Lock_policy)2>::__shared_count<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>*&, std::_Sp_alloc_shared_tag<std::allocator<int> >, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr_base.h:648)
==18980==    by 0x10CB35: std::__shared_ptr<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, (__gnu_cxx::_Lock_policy)2>::__shared_ptr<std::allocator<int>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::_Sp_alloc_shared_tag<std::allocator<int> >, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr_base.h:1342)
==18980==    by 0x10CA62: std::shared_ptr<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()> >::shared_ptr<std::allocator<int>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::_Sp_alloc_shared_tag<std::allocator<int> >, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr.h:409)
==18980==    by 0x10C9D5: std::shared_ptr<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()> > std::allocate_shared<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::allocator<int> const&, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr.h:863)
==18980==    by 0x10C952: std::shared_ptr<std::__future_base::_Task_state_base<int ()> > std::__create_task_state<int (), std::_Bind<main::{lambda()#1} ()>, std::allocator<int> >(std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (future:1504)
==18980==    by 0x10C87F: std::packaged_task<int ()>::packaged_task<std::_Bind<main::{lambda()#1} ()>, void>(std::_Bind<main::{lambda()#1} ()>&&) (future:1535)
==18980==    by 0x10C77E: void __gnu_cxx::new_allocator<std::packaged_task<int ()> >::construct<std::packaged_task<int ()>, std::_Bind<main::{lambda()#1} ()> >(std::packaged_task<int ()>*, std::_Bind<main::{lambda()#1} ()>&&) (new_allocator.h:162)
==18980==    by 0x10C679: void std::allocator_traits<std::allocator<std::packaged_task<int ()> > >::construct<std::packaged_task<int ()>, std::_Bind<main::{lambda()#1} ()> >(std::allocator<std::packaged_task<int ()> >&, std::packaged_task<int ()>*, std::_Bind<main::{lambda()#1} ()>&&) (alloc_traits.h:516)
==18980==  Block was alloc'd by thread #1
==18980== 
==18980== ----------------------------------------------------------------
==18980== 
==18980== Possible data race during read of size 4 at 0x4DEA750 by thread #1
==18980== Locks held: none
==18980==    at 0x110FC3: std::future<int>::get() (future:805)
==18980==    by 0x10B94E: main (example.cpp:26)
==18980== 
==18980== This conflicts with a previous write of size 4 by thread #3
==18980== Locks held: none
==18980==    at 0x11708C: std::__future_base::_Result<int>::_M_set(int&&) (future:257)
==18980==    by 0x10E227: std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_M_run()::{lambda()#1}, int>::operator()() const (future:1386)
==18980==    by 0x10E070: std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter> std::__invoke_impl<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_M_run()::{lambda()#1}, int>&>(std::__invoke_other, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_M_run()::{lambda()#1}, int>&) (invoke.h:61)
==18980==    by 0x10DD34: std::enable_if<is_invocable_r_v<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_M_run()::{lambda()#1}, int>&>, std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> >::type std::__invoke_r<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_M_run()::{lambda()#1}, int>&>(std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_M_run()::{lambda()#1}, int>&) (invoke.h:116)
==18980==    by 0x10DA71: std::_Function_handler<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> (), std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_M_run()::{lambda()#1}, int> >::_M_invoke(std::_Any_data const&) (std_function.h:291)
==18980==    by 0x1101D3: std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>::operator()() const (std_function.h:590)
==18980==    by 0x10F3FF: std::__future_base::_State_baseV2::_M_do_set(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*) (future:571)
==18980==    by 0x112BB4: void std::__invoke_impl<void, void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::__invoke_memfun_deref, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) (invoke.h:74)
==18980==  Address 0x4dea750 is 16 bytes inside a block of size 24 alloc'd
==18980==    at 0x484B093: operator new(unsigned long) (in /usr/libexec/valgrind/vgpreload_helgrind-amd64-linux.so)
==18980==    by 0x116760: std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter> std::__future_base::_S_allocate_result<int, int>(std::allocator<int> const&) (future:302)
==18980==    by 0x11669E: std::__future_base::_Task_state_base<int ()>::_Task_state_base<std::allocator<int> >(std::allocator<int> const&) (future:1434)
==18980==    by 0x10D215: std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_Task_state<std::_Bind<main::{lambda()#1} ()> >(std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (future:1460)
==18980==    by 0x10D196: void __gnu_cxx::new_allocator<int>::construct<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>*, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (new_allocator.h:162)
==18980==    by 0x10D061: void std::allocator_traits<std::allocator<int> >::construct<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::allocator<int>&, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>*, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (alloc_traits.h:516)
==18980==    by 0x10CEB4: std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2>::_Sp_counted_ptr_inplace<std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::allocator<int>, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr_base.h:519)
==18980==    by 0x10CC2E: std::__shared_count<(__gnu_cxx::_Lock_policy)2>::__shared_count<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>*&, std::_Sp_alloc_shared_tag<std::allocator<int> >, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr_base.h:650)
==18980==    by 0x10CB35: std::__shared_ptr<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, (__gnu_cxx::_Lock_policy)2>::__shared_ptr<std::allocator<int>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::_Sp_alloc_shared_tag<std::allocator<int> >, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr_base.h:1342)
==18980==    by 0x10CA62: std::shared_ptr<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()> >::shared_ptr<std::allocator<int>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::_Sp_alloc_shared_tag<std::allocator<int> >, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr.h:409)
==18980==    by 0x10C9D5: std::shared_ptr<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()> > std::allocate_shared<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::allocator<int> const&, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr.h:863)
==18980==    by 0x10C952: std::shared_ptr<std::__future_base::_Task_state_base<int ()> > std::__create_task_state<int (), std::_Bind<main::{lambda()#1} ()>, std::allocator<int> >(std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (future:1504)
==18980==  Block was alloc'd by thread #1
==18980== 
==18980== ----------------------------------------------------------------
==18980== 
==18980== Possible data race during write of size 8 at 0x4DEA6D0 by thread #1
==18980== Locks held: none
==18980==    at 0x10D2AF: std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::~_Task_state() (future:1454)
==18980==    by 0x10D9AF: void __gnu_cxx::new_allocator<int>::destroy<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()> >(std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>*) (new_allocator.h:168)
==18980==    by 0x10D79C: void std::allocator_traits<std::allocator<int> >::destroy<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()> >(std::allocator<int>&, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>*) (alloc_traits.h:535)
==18980==    by 0x10D400: std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2>::_M_dispose() (shared_ptr_base.h:528)
==18980==    by 0x1110D2: std::_Sp_counted_base<(__gnu_cxx::_Lock_policy)2>::_M_release() (shared_ptr_base.h:168)
==18980==    by 0x10FB90: std::__shared_count<(__gnu_cxx::_Lock_policy)2>::~__shared_count() (shared_ptr_base.h:705)
==18980==    by 0x10F483: std::__shared_ptr<std::__future_base::_State_baseV2, (__gnu_cxx::_Lock_policy)2>::~__shared_ptr() (shared_ptr_base.h:1154)
==18980==    by 0x1117A1: std::__shared_ptr<std::__future_base::_State_baseV2, (__gnu_cxx::_Lock_policy)2>::reset() (shared_ptr_base.h:1272)
==18980==    by 0x11284E: std::__basic_future<int>::_Reset::~_Reset() (future:755)
==18980==    by 0x110FD0: std::future<int>::get() (future:806)
==18980==    by 0x10B94E: main (example.cpp:26)
==18980== 
==18980== This conflicts with a previous read of size 8 by thread #3
==18980== Locks held: none
==18980==    at 0x112528: std::packaged_task<int ()>::operator()() (future:1604)
==18980==    by 0x10BA23: ThreadPool::enqueue<main::{lambda()#1}>(main::{lambda()#1}&&)::{lambda()#1}::operator()() const (ThreadPool.h:80)
==18980==    by 0x10C6C5: void std::__invoke_impl<void, ThreadPool::enqueue<main::{lambda()#1}>(main::{lambda()#1}&&)::{lambda()#1}&>(std::__invoke_other, ThreadPool::enqueue<main::{lambda()#1}>(main::{lambda()#1}&&)::{lambda()#1}&) (invoke.h:61)
==18980==    by 0x10C57F: std::enable_if<is_invocable_r_v<void, ThreadPool::enqueue<main::{lambda()#1}>(main::{lambda()#1}&&)::{lambda()#1}&>, void>::type std::__invoke_r<void, ThreadPool::enqueue<main::{lambda()#1}>(main::{lambda()#1}&&)::{lambda()#1}&>(ThreadPool::enqueue<main::{lambda()#1}>(main::{lambda()#1}&&)::{lambda()#1}&) (invoke.h:111)
==18980==    by 0x10C359: std::_Function_handler<void (), ThreadPool::enqueue<main::{lambda()#1}>(main::{lambda()#1}&&)::{lambda()#1}>::_M_invoke(std::_Any_data const&) (std_function.h:290)
==18980==    by 0x110807: std::function<void ()>::operator()() const (std_function.h:590)
==18980==    by 0x10F6DF: ThreadPool::ThreadPool(unsigned long)::{lambda()#1}::operator()() const (ThreadPool.h:55)
==18980==    by 0x116F99: void std::__invoke_impl<void, ThreadPool::ThreadPool(unsigned long)::{lambda()#1}>(std::__invoke_other, ThreadPool::ThreadPool(unsigned long)::{lambda()#1}&&) (invoke.h:61)
==18980==  Address 0x4dea6d0 is 16 bytes inside a block of size 64 alloc'd
==18980==    at 0x484B093: operator new(unsigned long) (in /usr/libexec/valgrind/vgpreload_helgrind-amd64-linux.so)
==18980==    by 0x10D0F5: __gnu_cxx::new_allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> >::allocate(unsigned long, void const*) (new_allocator.h:127)
==18980==    by 0x10CF7C: std::allocator_traits<std::allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> > >::allocate(std::allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> >&, unsigned long) (alloc_traits.h:464)
==18980==    by 0x10CD69: std::__allocated_ptr<std::allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> > > std::__allocate_guarded<std::allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> > >(std::allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> >&) (allocated_ptr.h:98)
==18980==    by 0x10CBBB: std::__shared_count<(__gnu_cxx::_Lock_policy)2>::__shared_count<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>*&, std::_Sp_alloc_shared_tag<std::allocator<int> >, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr_base.h:648)
==18980==    by 0x10CB35: std::__shared_ptr<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, (__gnu_cxx::_Lock_policy)2>::__shared_ptr<std::allocator<int>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::_Sp_alloc_shared_tag<std::allocator<int> >, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr_base.h:1342)
==18980==    by 0x10CA62: std::shared_ptr<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()> >::shared_ptr<std::allocator<int>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::_Sp_alloc_shared_tag<std::allocator<int> >, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr.h:409)
==18980==    by 0x10C9D5: std::shared_ptr<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()> > std::allocate_shared<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::allocator<int> const&, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr.h:863)
==18980==    by 0x10C952: std::shared_ptr<std::__future_base::_Task_state_base<int ()> > std::__create_task_state<int (), std::_Bind<main::{lambda()#1} ()>, std::allocator<int> >(std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (future:1504)
==18980==    by 0x10C87F: std::packaged_task<int ()>::packaged_task<std::_Bind<main::{lambda()#1} ()>, void>(std::_Bind<main::{lambda()#1} ()>&&) (future:1535)
==18980==    by 0x10C77E: void __gnu_cxx::new_allocator<std::packaged_task<int ()> >::construct<std::packaged_task<int ()>, std::_Bind<main::{lambda()#1} ()> >(std::packaged_task<int ()>*, std::_Bind<main::{lambda()#1} ()>&&) (new_allocator.h:162)
==18980==    by 0x10C679: void std::allocator_traits<std::allocator<std::packaged_task<int ()> > >::construct<std::packaged_task<int ()>, std::_Bind<main::{lambda()#1} ()> >(std::allocator<std::packaged_task<int ()> >&, std::packaged_task<int ()>*, std::_Bind<main::{lambda()#1} ()>&&) (alloc_traits.h:516)
==18980==  Block was alloc'd by thread #1
==18980== 
==18980== ----------------------------------------------------------------
==18980== 
==18980== Possible data race during read of size 8 at 0x4DEA6F0 by thread #1
==18980== Locks held: none
==18980==    at 0x1166FF: std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>::~unique_ptr() (unique_ptr.h:360)
==18980==    by 0x116609: std::__future_base::_Task_state_base<int ()>::~_Task_state_base() (future:1427)
==18980==    by 0x10D2CD: std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::~_Task_state() (future:1454)
==18980==    by 0x10D9AF: void __gnu_cxx::new_allocator<int>::destroy<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()> >(std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>*) (new_allocator.h:168)
==18980==    by 0x10D79C: void std::allocator_traits<std::allocator<int> >::destroy<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()> >(std::allocator<int>&, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>*) (alloc_traits.h:535)
==18980==    by 0x10D400: std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2>::_M_dispose() (shared_ptr_base.h:528)
==18980==    by 0x1110D2: std::_Sp_counted_base<(__gnu_cxx::_Lock_policy)2>::_M_release() (shared_ptr_base.h:168)
==18980==    by 0x10FB90: std::__shared_count<(__gnu_cxx::_Lock_policy)2>::~__shared_count() (shared_ptr_base.h:705)
==18980==    by 0x10F483: std::__shared_ptr<std::__future_base::_State_baseV2, (__gnu_cxx::_Lock_policy)2>::~__shared_ptr() (shared_ptr_base.h:1154)
==18980==    by 0x1117A1: std::__shared_ptr<std::__future_base::_State_baseV2, (__gnu_cxx::_Lock_policy)2>::reset() (shared_ptr_base.h:1272)
==18980==    by 0x11284E: std::__basic_future<int>::_Reset::~_Reset() (future:755)
==18980==    by 0x110FD0: std::future<int>::get() (future:806)
==18980== 
==18980== This conflicts with a previous write of size 8 by thread #3
==18980== Locks held: none
==18980==    at 0x11713C: std::__uniq_ptr_impl<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>::__uniq_ptr_impl(std::__uniq_ptr_impl<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>&&) (unique_ptr.h:163)
==18980==    by 0x116FC4: std::__uniq_ptr_data<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter, true, true>::__uniq_ptr_data(std::__uniq_ptr_data<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter, true, true>&&) (unique_ptr.h:211)
==18980==    by 0x116FEE: std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>::unique_ptr(std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>&&) (unique_ptr.h:327)
==18980==    by 0x10E248: std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_M_run()::{lambda()#1}, int>::operator()() const (future:1396)
==18980==    by 0x10E070: std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter> std::__invoke_impl<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_M_run()::{lambda()#1}, int>&>(std::__invoke_other, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_M_run()::{lambda()#1}, int>&) (invoke.h:61)
==18980==    by 0x10DD34: std::enable_if<is_invocable_r_v<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_M_run()::{lambda()#1}, int>&>, std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> >::type std::__invoke_r<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_M_run()::{lambda()#1}, int>&>(std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_M_run()::{lambda()#1}, int>&) (invoke.h:116)
==18980==    by 0x10DA71: std::_Function_handler<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> (), std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_M_run()::{lambda()#1}, int> >::_M_invoke(std::_Any_data const&) (std_function.h:291)
==18980==    by 0x1101D3: std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>::operator()() const (std_function.h:590)
==18980==  Address 0x4dea6f0 is 48 bytes inside a block of size 64 alloc'd
==18980==    at 0x484B093: operator new(unsigned long) (in /usr/libexec/valgrind/vgpreload_helgrind-amd64-linux.so)
==18980==    by 0x10D0F5: __gnu_cxx::new_allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> >::allocate(unsigned long, void const*) (new_allocator.h:127)
==18980==    by 0x10CF7C: std::allocator_traits<std::allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> > >::allocate(std::allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> >&, unsigned long) (alloc_traits.h:464)
==18980==    by 0x10CD69: std::__allocated_ptr<std::allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> > > std::__allocate_guarded<std::allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> > >(std::allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> >&) (allocated_ptr.h:98)
==18980==    by 0x10CBBB: std::__shared_count<(__gnu_cxx::_Lock_policy)2>::__shared_count<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>*&, std::_Sp_alloc_shared_tag<std::allocator<int> >, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr_base.h:648)
==18980==    by 0x10CB35: std::__shared_ptr<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, (__gnu_cxx::_Lock_policy)2>::__shared_ptr<std::allocator<int>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::_Sp_alloc_shared_tag<std::allocator<int> >, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr_base.h:1342)
==18980==    by 0x10CA62: std::shared_ptr<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()> >::shared_ptr<std::allocator<int>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::_Sp_alloc_shared_tag<std::allocator<int> >, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr.h:409)
==18980==    by 0x10C9D5: std::shared_ptr<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()> > std::allocate_shared<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::allocator<int> const&, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr.h:863)
==18980==    by 0x10C952: std::shared_ptr<std::__future_base::_Task_state_base<int ()> > std::__create_task_state<int (), std::_Bind<main::{lambda()#1} ()>, std::allocator<int> >(std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (future:1504)
==18980==    by 0x10C87F: std::packaged_task<int ()>::packaged_task<std::_Bind<main::{lambda()#1} ()>, void>(std::_Bind<main::{lambda()#1} ()>&&) (future:1535)
==18980==    by 0x10C77E: void __gnu_cxx::new_allocator<std::packaged_task<int ()> >::construct<std::packaged_task<int ()>, std::_Bind<main::{lambda()#1} ()> >(std::packaged_task<int ()>*, std::_Bind<main::{lambda()#1} ()>&&) (new_allocator.h:162)
==18980==    by 0x10C679: void std::allocator_traits<std::allocator<std::packaged_task<int ()> > >::construct<std::packaged_task<int ()>, std::_Bind<main::{lambda()#1} ()> >(std::allocator<std::packaged_task<int ()> >&, std::packaged_task<int ()>*, std::_Bind<main::{lambda()#1} ()>&&) (alloc_traits.h:516)
==18980==  Block was alloc'd by thread #1
==18980== 
==18980== ----------------------------------------------------------------
==18980== 
==18980== Possible data race during write of size 8 at 0x4DEA6F0 by thread #1
==18980== Locks held: none
==18980==    at 0x116734: std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>::~unique_ptr() (unique_ptr.h:362)
==18980==    by 0x116609: std::__future_base::_Task_state_base<int ()>::~_Task_state_base() (future:1427)
==18980==    by 0x10D2CD: std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::~_Task_state() (future:1454)
==18980==    by 0x10D9AF: void __gnu_cxx::new_allocator<int>::destroy<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()> >(std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>*) (new_allocator.h:168)
==18980==    by 0x10D79C: void std::allocator_traits<std::allocator<int> >::destroy<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()> >(std::allocator<int>&, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>*) (alloc_traits.h:535)
==18980==    by 0x10D400: std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2>::_M_dispose() (shared_ptr_base.h:528)
==18980==    by 0x1110D2: std::_Sp_counted_base<(__gnu_cxx::_Lock_policy)2>::_M_release() (shared_ptr_base.h:168)
==18980==    by 0x10FB90: std::__shared_count<(__gnu_cxx::_Lock_policy)2>::~__shared_count() (shared_ptr_base.h:705)
==18980==    by 0x10F483: std::__shared_ptr<std::__future_base::_State_baseV2, (__gnu_cxx::_Lock_policy)2>::~__shared_ptr() (shared_ptr_base.h:1154)
==18980==    by 0x1117A1: std::__shared_ptr<std::__future_base::_State_baseV2, (__gnu_cxx::_Lock_policy)2>::reset() (shared_ptr_base.h:1272)
==18980==    by 0x11284E: std::__basic_future<int>::_Reset::~_Reset() (future:755)
==18980==    by 0x110FD0: std::future<int>::get() (future:806)
==18980== 
==18980== This conflicts with a previous write of size 8 by thread #3
==18980== Locks held: none
==18980==    at 0x11713C: std::__uniq_ptr_impl<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>::__uniq_ptr_impl(std::__uniq_ptr_impl<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>&&) (unique_ptr.h:163)
==18980==    by 0x116FC4: std::__uniq_ptr_data<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter, true, true>::__uniq_ptr_data(std::__uniq_ptr_data<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter, true, true>&&) (unique_ptr.h:211)
==18980==    by 0x116FEE: std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>::unique_ptr(std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>&&) (unique_ptr.h:327)
==18980==    by 0x10E248: std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_M_run()::{lambda()#1}, int>::operator()() const (future:1396)
==18980==    by 0x10E070: std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter> std::__invoke_impl<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_M_run()::{lambda()#1}, int>&>(std::__invoke_other, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_M_run()::{lambda()#1}, int>&) (invoke.h:61)
==18980==    by 0x10DD34: std::enable_if<is_invocable_r_v<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_M_run()::{lambda()#1}, int>&>, std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> >::type std::__invoke_r<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_M_run()::{lambda()#1}, int>&>(std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_M_run()::{lambda()#1}, int>&) (invoke.h:116)
==18980==    by 0x10DA71: std::_Function_handler<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> (), std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_M_run()::{lambda()#1}, int> >::_M_invoke(std::_Any_data const&) (std_function.h:291)
==18980==    by 0x1101D3: std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>::operator()() const (std_function.h:590)
==18980==  Address 0x4dea6f0 is 48 bytes inside a block of size 64 alloc'd
==18980==    at 0x484B093: operator new(unsigned long) (in /usr/libexec/valgrind/vgpreload_helgrind-amd64-linux.so)
==18980==    by 0x10D0F5: __gnu_cxx::new_allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> >::allocate(unsigned long, void const*) (new_allocator.h:127)
==18980==    by 0x10CF7C: std::allocator_traits<std::allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> > >::allocate(std::allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> >&, unsigned long) (alloc_traits.h:464)
==18980==    by 0x10CD69: std::__allocated_ptr<std::allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> > > std::__allocate_guarded<std::allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> > >(std::allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> >&) (allocated_ptr.h:98)
==18980==    by 0x10CBBB: std::__shared_count<(__gnu_cxx::_Lock_policy)2>::__shared_count<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>*&, std::_Sp_alloc_shared_tag<std::allocator<int> >, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr_base.h:648)
==18980==    by 0x10CB35: std::__shared_ptr<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, (__gnu_cxx::_Lock_policy)2>::__shared_ptr<std::allocator<int>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::_Sp_alloc_shared_tag<std::allocator<int> >, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr_base.h:1342)
==18980==    by 0x10CA62: std::shared_ptr<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()> >::shared_ptr<std::allocator<int>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::_Sp_alloc_shared_tag<std::allocator<int> >, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr.h:409)
==18980==    by 0x10C9D5: std::shared_ptr<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()> > std::allocate_shared<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::allocator<int> const&, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr.h:863)
==18980==    by 0x10C952: std::shared_ptr<std::__future_base::_Task_state_base<int ()> > std::__create_task_state<int (), std::_Bind<main::{lambda()#1} ()>, std::allocator<int> >(std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (future:1504)
==18980==    by 0x10C87F: std::packaged_task<int ()>::packaged_task<std::_Bind<main::{lambda()#1} ()>, void>(std::_Bind<main::{lambda()#1} ()>&&) (future:1535)
==18980==    by 0x10C77E: void __gnu_cxx::new_allocator<std::packaged_task<int ()> >::construct<std::packaged_task<int ()>, std::_Bind<main::{lambda()#1} ()> >(std::packaged_task<int ()>*, std::_Bind<main::{lambda()#1} ()>&&) (new_allocator.h:162)
==18980==    by 0x10C679: void std::allocator_traits<std::allocator<std::packaged_task<int ()> > >::construct<std::packaged_task<int ()>, std::_Bind<main::{lambda()#1} ()> >(std::allocator<std::packaged_task<int ()> >&, std::packaged_task<int ()>*, std::_Bind<main::{lambda()#1} ()>&&) (alloc_traits.h:516)
==18980==  Block was alloc'd by thread #1
==18980== 
==18980== ----------------------------------------------------------------
==18980== 
==18980== Possible data race during read of size 1 at 0x4DEA754 by thread #1
==18980== Locks held: none
==18980==    at 0x116C50: std::__future_base::_Result<int>::~_Result() (future:239)
==18980==    by 0x116C8F: std::__future_base::_Result<int>::~_Result() (future:241)
==18980==    by 0x116C29: std::__future_base::_Result<int>::_M_destroy() (future:262)
==18980==    by 0x10EDCC: std::__future_base::_Result_base::_Deleter::operator()(std::__future_base::_Result_base*) const (future:212)
==18980==    by 0x10FC8F: std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>::~unique_ptr() (unique_ptr.h:361)
==18980==    by 0x1165A7: std::__future_base::_State_baseV2::~_State_baseV2() (future:327)
==18980==    by 0x116615: std::__future_base::_Task_state_base<int ()>::~_Task_state_base() (future:1427)
==18980==    by 0x10D2CD: std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::~_Task_state() (future:1454)
==18980==    by 0x10D9AF: void __gnu_cxx::new_allocator<int>::destroy<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()> >(std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>*) (new_allocator.h:168)
==18980==    by 0x10D79C: void std::allocator_traits<std::allocator<int> >::destroy<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()> >(std::allocator<int>&, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>*) (alloc_traits.h:535)
==18980==    by 0x10D400: std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2>::_M_dispose() (shared_ptr_base.h:528)
==18980==    by 0x1110D2: std::_Sp_counted_base<(__gnu_cxx::_Lock_policy)2>::_M_release() (shared_ptr_base.h:168)
==18980== 
==18980== This conflicts with a previous write of size 1 by thread #3
==18980== Locks held: none
==18980==    at 0x117092: std::__future_base::_Result<int>::_M_set(int&&) (future:258)
==18980==    by 0x10E227: std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_M_run()::{lambda()#1}, int>::operator()() const (future:1386)
==18980==    by 0x10E070: std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter> std::__invoke_impl<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_M_run()::{lambda()#1}, int>&>(std::__invoke_other, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_M_run()::{lambda()#1}, int>&) (invoke.h:61)
==18980==    by 0x10DD34: std::enable_if<is_invocable_r_v<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_M_run()::{lambda()#1}, int>&>, std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> >::type std::__invoke_r<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_M_run()::{lambda()#1}, int>&>(std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_M_run()::{lambda()#1}, int>&) (invoke.h:116)
==18980==    by 0x10DA71: std::_Function_handler<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> (), std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_M_run()::{lambda()#1}, int> >::_M_invoke(std::_Any_data const&) (std_function.h:291)
==18980==    by 0x1101D3: std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>::operator()() const (std_function.h:590)
==18980==    by 0x10F3FF: std::__future_base::_State_baseV2::_M_do_set(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*) (future:571)
==18980==    by 0x112BB4: void std::__invoke_impl<void, void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::__invoke_memfun_deref, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) (invoke.h:74)
==18980==  Address 0x4dea754 is 20 bytes inside a block of size 24 alloc'd
==18980==    at 0x484B093: operator new(unsigned long) (in /usr/libexec/valgrind/vgpreload_helgrind-amd64-linux.so)
==18980==    by 0x116760: std::unique_ptr<std::__future_base::_Result<int>, std::__future_base::_Result_base::_Deleter> std::__future_base::_S_allocate_result<int, int>(std::allocator<int> const&) (future:302)
==18980==    by 0x11669E: std::__future_base::_Task_state_base<int ()>::_Task_state_base<std::allocator<int> >(std::allocator<int> const&) (future:1434)
==18980==    by 0x10D215: std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::_Task_state<std::_Bind<main::{lambda()#1} ()> >(std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (future:1460)
==18980==    by 0x10D196: void __gnu_cxx::new_allocator<int>::construct<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>*, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (new_allocator.h:162)
==18980==    by 0x10D061: void std::allocator_traits<std::allocator<int> >::construct<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::allocator<int>&, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>*, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (alloc_traits.h:516)
==18980==    by 0x10CEB4: std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2>::_Sp_counted_ptr_inplace<std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::allocator<int>, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr_base.h:519)
==18980==    by 0x10CC2E: std::__shared_count<(__gnu_cxx::_Lock_policy)2>::__shared_count<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>*&, std::_Sp_alloc_shared_tag<std::allocator<int> >, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr_base.h:650)
==18980==    by 0x10CB35: std::__shared_ptr<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, (__gnu_cxx::_Lock_policy)2>::__shared_ptr<std::allocator<int>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::_Sp_alloc_shared_tag<std::allocator<int> >, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr_base.h:1342)
==18980==    by 0x10CA62: std::shared_ptr<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()> >::shared_ptr<std::allocator<int>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::_Sp_alloc_shared_tag<std::allocator<int> >, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr.h:409)
==18980==    by 0x10C9D5: std::shared_ptr<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()> > std::allocate_shared<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::allocator<int> const&, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr.h:863)
==18980==    by 0x10C952: std::shared_ptr<std::__future_base::_Task_state_base<int ()> > std::__create_task_state<int (), std::_Bind<main::{lambda()#1} ()>, std::allocator<int> >(std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (future:1504)
==18980==  Block was alloc'd by thread #1
==18980== 
==18980== ----------------------------------------------------------------
==18980== 
==18980== Possible data race during write of size 8 at 0x4DEA6D8 by thread #1
==18980== Locks held: none
==18980==    at 0x10FC94: std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>::~unique_ptr() (unique_ptr.h:362)
==18980==    by 0x1165A7: std::__future_base::_State_baseV2::~_State_baseV2() (future:327)
==18980==    by 0x116615: std::__future_base::_Task_state_base<int ()>::~_Task_state_base() (future:1427)
==18980==    by 0x10D2CD: std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>::~_Task_state() (future:1454)
==18980==    by 0x10D9AF: void __gnu_cxx::new_allocator<int>::destroy<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()> >(std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>*) (new_allocator.h:168)
==18980==    by 0x10D79C: void std::allocator_traits<std::allocator<int> >::destroy<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()> >(std::allocator<int>&, std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>*) (alloc_traits.h:535)
==18980==    by 0x10D400: std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2>::_M_dispose() (shared_ptr_base.h:528)
==18980==    by 0x1110D2: std::_Sp_counted_base<(__gnu_cxx::_Lock_policy)2>::_M_release() (shared_ptr_base.h:168)
==18980==    by 0x10FB90: std::__shared_count<(__gnu_cxx::_Lock_policy)2>::~__shared_count() (shared_ptr_base.h:705)
==18980==    by 0x10F483: std::__shared_ptr<std::__future_base::_State_baseV2, (__gnu_cxx::_Lock_policy)2>::~__shared_ptr() (shared_ptr_base.h:1154)
==18980==    by 0x1117A1: std::__shared_ptr<std::__future_base::_State_baseV2, (__gnu_cxx::_Lock_policy)2>::reset() (shared_ptr_base.h:1272)
==18980==    by 0x11284E: std::__basic_future<int>::_Reset::~_Reset() (future:755)
==18980== 
==18980== This conflicts with a previous write of size 8 by thread #3
==18980== Locks held: none
==18980==    at 0x112D10: std::enable_if<std::__and_<std::__not_<std::__is_tuple_like<std::__future_base::_Result_base*> >, std::is_move_constructible<std::__future_base::_Result_base*>, std::is_move_assignable<std::__future_base::_Result_base*> >::value, void>::type std::swap<std::__future_base::_Result_base*>(std::__future_base::_Result_base*&, std::__future_base::_Result_base*&) (move.h:205)
==18980==    by 0x1116EA: std::__uniq_ptr_impl<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>::swap(std::__uniq_ptr_impl<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>&) (unique_ptr.h:196)
==18980==    by 0x110180: std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>::swap(std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>&) (unique_ptr.h:464)
==18980==    by 0x10F41D: std::__future_base::_State_baseV2::_M_do_set(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*) (future:576)
==18980==    by 0x112BB4: void std::__invoke_impl<void, void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::__invoke_memfun_deref, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) (invoke.h:74)
==18980==    by 0x111306: std::__invoke_result<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>::type std::__invoke<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) (invoke.h:96)
==18980==    by 0x10FD81: std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#1}::operator()() const (mutex:776)
==18980==    by 0x111336: std::once_flag::_Prepare_execution::_Prepare_execution<std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#1}>(void (std::__future_base::_State_baseV2::*&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*))::{lambda()#1}::operator()() const (mutex:712)
==18980==  Address 0x4dea6d8 is 24 bytes inside a block of size 64 alloc'd
==18980==    at 0x484B093: operator new(unsigned long) (in /usr/libexec/valgrind/vgpreload_helgrind-amd64-linux.so)
==18980==    by 0x10D0F5: __gnu_cxx::new_allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> >::allocate(unsigned long, void const*) (new_allocator.h:127)
==18980==    by 0x10CF7C: std::allocator_traits<std::allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> > >::allocate(std::allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> >&, unsigned long) (alloc_traits.h:464)
==18980==    by 0x10CD69: std::__allocated_ptr<std::allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> > > std::__allocate_guarded<std::allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> > >(std::allocator<std::_Sp_counted_ptr_inplace<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, (__gnu_cxx::_Lock_policy)2> >&) (allocated_ptr.h:98)
==18980==    by 0x10CBBB: std::__shared_count<(__gnu_cxx::_Lock_policy)2>::__shared_count<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>*&, std::_Sp_alloc_shared_tag<std::allocator<int> >, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr_base.h:648)
==18980==    by 0x10CB35: std::__shared_ptr<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, (__gnu_cxx::_Lock_policy)2>::__shared_ptr<std::allocator<int>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::_Sp_alloc_shared_tag<std::allocator<int> >, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr_base.h:1342)
==18980==    by 0x10CA62: std::shared_ptr<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()> >::shared_ptr<std::allocator<int>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::_Sp_alloc_shared_tag<std::allocator<int> >, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr.h:409)
==18980==    by 0x10C9D5: std::shared_ptr<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()> > std::allocate_shared<std::__future_base::_Task_state<std::_Bind<main::{lambda()#1} ()>, std::allocator<int>, int ()>, std::allocator<int>, std::_Bind<main::{lambda()#1} ()>, std::allocator<int> const&>(std::allocator<int> const&, std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (shared_ptr.h:863)
==18980==    by 0x10C952: std::shared_ptr<std::__future_base::_Task_state_base<int ()> > std::__create_task_state<int (), std::_Bind<main::{lambda()#1} ()>, std::allocator<int> >(std::_Bind<main::{lambda()#1} ()>&&, std::allocator<int> const&) (future:1504)
==18980==    by 0x10C87F: std::packaged_task<int ()>::packaged_task<std::_Bind<main::{lambda()#1} ()>, void>(std::_Bind<main::{lambda()#1} ()>&&) (future:1535)
==18980==    by 0x10C77E: void __gnu_cxx::new_allocator<std::packaged_task<int ()> >::construct<std::packaged_task<int ()>, std::_Bind<main::{lambda()#1} ()> >(std::packaged_task<int ()>*, std::_Bind<main::{lambda()#1} ()>&&) (new_allocator.h:162)
==18980==    by 0x10C679: void std::allocator_traits<std::allocator<std::packaged_task<int ()> > >::construct<std::packaged_task<int ()>, std::_Bind<main::{lambda()#1} ()> >(std::allocator<std::packaged_task<int ()> >&, std::packaged_task<int ()>*, std::_Bind<main::{lambda()#1} ()>&&) (alloc_traits.h:516)
==18980==  Block was alloc'd by thread #1
==18980== 
==18980== ----------------------------------------------------------------
==18980== 
==18980== Thread #1: pthread_cond_{signal,broadcast}: dubious: associated lock is not held by any thread
==18980==    at 0x48515C6: ??? (in /usr/libexec/valgrind/vgpreload_helgrind-amd64-linux.so)
==18980==    by 0x10F920: ThreadPool::~ThreadPool() (ThreadPool.h:93)
==18980==    by 0x10B99D: main (example.cpp:30)
==18980== 
==18980== 
==18980== Use --history-level=approx or =none to gain increased speed, at
==18980== the cost of reduced accuracy of conflicting-access information
==18980== For lists of detected and suppressed errors, rerun with: -s
==18980== ERROR SUMMARY: 62 errors from 9 contexts (suppressed: 140 from 13)
